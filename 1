Полная инструкция по настройке доменного контроллера Samba на BR-SRV
1. Подготовка окружения
BR-SRV: Debian 10, IP: 192.168.200.2, DNS: 192.168.100.2 (HQ-SRV).

HQ-CLI: Debian 10, получает IP по DHCP из VLAN200.

Доменное имя: au-team.irpo.

2. Установка Samba в режиме доменного контроллера
bash
Copy
# Обновление системы и установка пакетов
sudo apt update && sudo apt upgrade -y
sudo apt install -y samba krb5-user winbind smbclient

# Настройка Kerberos (укажите доменное имя)
sudo nano /etc/krb5.conf
Ответы при настройке Kerberos:

[libdefaults]
    default_realm = AU-TEAM.IRPO
    dns_lookup_realm = false
    dns_lookup_kdc = true
    ticket_lifetime = 24h
    renew_lifetime = 7d
    forwardable = true

[realms]
    AU-TEAM.IRPO = {
        kdc = br-srv.au-team.irpo
        admin_server = br-srv.au-team.irpo
        default_domain = au-team.irpo
    }

[domain_realm]
    .au-team.irpo = AU-TEAM.IRPO
    au-team.irpo = AU-TEAM.IRPO

[logging]
    kdc = FILE:/var/log/krb5/kdc.log
    admin_server = FILE:/var/log/krb5/admin.log
    default = FILE:/var/log/krb5/krb5lib.log



    
Copy
Default Kerberos version 5 realm: AU-TEAM.IRPO
Kerberos servers: br-srv.au-team.irpo
Administrative server: br-srv.au-team.irpo
3. Создание домена
bash
Copy
# Резервное копирование конфига
sudo mv /etc/samba/smb.conf /etc/samba/smb.conf.bak

# Создание домена
sudo samba-tool domain provision \
  --realm=AU-TEAM.IRPO \
  --domain=AU-TEAM \
  --adminpass=MyAdminPass123! \
  --server-role=dc \
  --use-rfc2307

# Запуск служб
sudo systemctl stop smbd nmbd winbind
sudo systemctl unmask samba-ad-dc
sudo systemctl enable samba-ad-dc
sudo systemctl start samba-ad-dc
4. Создание группы hq
bash
Copy
sudo samba-tool group add hq
5. Импорт пользователей из файла /opt/users.csv
5.1. Создайте файл /opt/users.csv:

csv
Copy
Username,Password
user1.hq,P@ssw0rd1
user2.hq,P@ssw0rd2
user3.hq,P@ssw0rd3
user4.hq,P@ssw0rd4
user5.hq,P@ssw0rd5
5.2. Импорт пользователей:

bash
Copy
sudo samba-tool user import /opt/users.csv --csv

# Добавление всех пользователей из CSV в группу hq
awk -F, 'NR>1 {print $1}' /opt/users.csv | while read user; do
  sudo samba-tool group addmembers hq "$user"
done
6. Настройка прав sudo для группы hq
bash
Copy
# Создайте файл правил sudo
echo '%hq ALL=(ALL) NOPASSWD: /bin/cat, /bin/grep, /usr/bin/id' | sudo tee /etc/sudoers.d/hq
sudo chmod 440 /etc/sudoers.d/hq

# Проверка синтаксиса
sudo visudo -cf /etc/sudoers.d/hq
7. Присоединение HQ-CLI к домену
На HQ-CLI:

bash
Copy
# Установка утилит
sudo apt install -y realmd sssd oddjob-mkhomedir

# Присоединение к домену
sudo realm join --user=Administrator au-team.irpo
Пароль администратора: MyAdminPass123!.

8. Проверка работоспособности
На BR-SRV:

bash
Copy
# Список пользователей
sudo samba-tool user list

# Проверка группы
sudo samba-tool group listmembers hq

# Тест аутентификации
smbclient -L localhost -U user1.hq
На HQ-CLI:

bash
Copy
# Проверка домена
sudo realm list

# Вход под пользователем
su - user1.hq

# Проверка прав
sudo cat /etc/passwd  # Разрешено
sudo apt update       # Запрещено
9. Устранение неполадок
Ошибки DNS: Убедитесь, что BR-SRV указан как DNS-сервер на HQ-CLI.

Синхронизация времени:

bash
Copy
sudo timedatectl set-ntp true
Фаервол: Разрешите трафик для доменных служб:

bash
Copy
sudo ufw allow 135,139,445,389,636/tcp
sudo ufw allow 53,88,123,137,138/udp




Шаг 1. Подготовка на BR‑SRV (источнике ключей)
1.1. Убедитесь, что для пользователя sshuser создан домашний каталог и у него правильные права
Если вы планируете генерировать ключи для пользователя sshuser на BR‑SRV, необходимо убедиться, что его домашний каталог существует и имеет корректные права. Если каталог отсутствует или права неверны, выполните следующие команды от имени root:

bash
Копировать
Редактировать
sudo mkdir -p /home/sshuser/.ssh
sudo chown -R sshuser:sshuser /home/sshuser
sudo chmod 700 /home/sshuser/.ssh
1.2. Переключитесь на пользователя sshuser
Чтобы сгенерировать ключи от имени пользователя sshuser, выполните:

bash
Копировать
Редактировать
su - sshuser
Теперь вы должны оказаться в домашнем каталоге пользователя sshuser (обычно /home/sshuser).

1.3. Генерация пары SSH‑ключей
Запустите команду генерации ключей:

bash
Копировать
Редактировать
ssh-keygen -t rsa
При появлении запроса:

"Enter file in which to save the key" — нажмите Enter, чтобы использовать значение по умолчанию: /home/sshuser/.ssh/id_rsa
При запросе пароля можно оставить его пустым (просто нажмите Enter дважды), если политика безопасности позволяет не задавать пароль.
После этого в каталоге /home/sshuser/.ssh должны появиться файлы:

id_rsa (закрытый ключ)
id_rsa.pub (открытый ключ)
Шаг 2. Копирование SSH‑ключей на целевые машины
Для копирования открытого ключа на целевые машины используйте команду ssh-copy-id. Если на целевых машинах SSH-сервер слушает на нестандартном порту, используйте опцию -p.

2.1. Копирование ключа на HQ‑SRV (SSH порт изменен, например, 2024)
На BR‑SRV (под пользователем, у которого сгенерированы ключи) выполните:

bash
Копировать
Редактировать
ssh-copy-id -p 2024 sshuser@192.168.100.2
При этом вам будет предложено ввести пароль для пользователя sshuser на HQ‑SRV.

2.2. Копирование ключа на HQ‑CLI
Если на HQ‑CLI используется пользователь user (или иной, укажите корректное имя):

bash
Копировать
Редактировать
ssh-copy-id user@192.168.100.66
2.3. Копирование ключа на HQ‑RTR
Если на HQ‑RTR используется пользователь net_admin:

bash
Копировать
Редактировать
ssh-copy-id net_admin@172.16.4.2
2.4. Копирование ключа на BR‑RTR
Если на BR‑RTR используется пользователь net_admin:

bash
Копировать
Редактировать
ssh-copy-id net_admin@172.16.5.2
После выполнения каждой из команд открытый ключ будет добавлен в файл ~/.ssh/authorized_keys на целевой машине, что позволит подключаться без ввода пароля.

Шаг 3. Проверка подключения
После успешного копирования ключей проверьте возможность подключения с BR‑SRV к каждой машине без запроса пароля. Например:

bash
Копировать
Редактировать
ssh -p 2024 sshuser@192.168.100.2
ssh user@192.168.100.66
ssh net_admin@172.16.4.2
ssh net_admin@172.16.5.2
